#!/sbin/openrc-run
# Copyright (c) 2007-2015 The OpenRC Authors.
# See the Authors file at the top-level directory of this distribution and
# https://github.com/OpenRC/openrc/blob/master/AUTHORS
#
# This file is part of OpenRC. It is subject to the license terms in
# the LICENSE file found in the top-level directory of this
# distribution and at https://github.com/OpenRC/openrc/blob/master/LICENSE
# This file may not be copied, modified, propagated, or distributed
# except according to the terms contained in the LICENSE file.

depend() {
	need localmount
	keyword -jail -prefix -shutdown
}

start() {
	if [ -n "$allscreen_flags" ]; then
		veinfo "Setting mode to $allscreen_flags for all screens"
		for v in /dev/ttyv*; do
			vidcontrol $allscreen_flags <$v
		done
	fi

	if [ -n "$keymap" -a "$keymap" != "NO" ]; then
		veinfo "Setting keymap to $keymap"
		kbdcontrol -l $keymap </dev/console
	fi

	if [ -n "$keyrate" -a "$keyrate" != "NO" ]; then
		veinfo "Setting keyrate to $keyrate"
		kbdcontrol -r $keyrate </dev/console
	fi

	if [ -n "$keychange" -a "$keychange" != "NO" ]; then
		veinfo "Changing function keys"
		eval set -- "$keychange"
		eindent
		while [ $# -gt 0 ]; do
			veinfo "F$1 -> \`$2'"
			kbdcontrol -f "$1" "$2" </dev/console
			veend $?
			shift; shift
		done
		eoutdent
	fi

	if [ -n "$cursor" -a "$cursor" != "NO" ]; then
		veinfo "Setting cursor"
		vidcontrol -c $cursor
	fi

	local v= f=
	for v in font8x16 font8x14 font8x8; do
		eval f=\$$v
		if [ -n "$f" -a "$f" != "NO" ]; then
			veinfo "Setting font $f"
			vidcontrol -f ${v##font} $f
		fi
	done

	if [ -n "$blanktime" -a "$blanktime" != "NO" ]; then
		veinfo "Setting blanktime"
		vidcontrol -t $blanktime
	fi

	if [ -n "$saver" -a "$saver" != "NO" ]; then
		local i=
		for i in $(kldstat | sed -n -e 's/.* \(splash_.*\)/\1/p'); do
			kldunload "$i"
		done
		kldstat -v | grep -q _saver || load_kld ${saver}_saver
	fi

	if [ -n "$kbdflags" -a "$kbdflags" != "NO" ]; then
		veinfo "Setting keyboard flags for all screens"
		for v in /dev/ttyv*; do
			kbdcontrol $kbdflags <$v
		done
	fi

	return 0
}
